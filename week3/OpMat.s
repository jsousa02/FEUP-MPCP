.text
.global OpMat
.type OpMat, "function"

OpMat:	STP 	X29, X30, [SP, -16]!
	MOV 	W6, 0

LOOP:	LDRB 	W9, [X2] // OPS
	CMP 	W9, 88 // X
	B.EQ 	END
	CMP 	W9, 76 // L
	B.EQ 	L
	CMP 	W9, 67 // C
	B.EQ 	C
	CMP	W9, 80 // P
	B.EQ	P
	CMP	W9, 66 // B
	B.EQ	B
	CMP 	W9, 79 // 0
	B.EQ	O
	B	END

O:	ADD	W6, W6, 1 
	ADD	X2, X2, 1 
	MOV	X4, X2
	ADD	X2, X2, 1 
	STP 	X0, X1, [SP, -16]! 
	STP	X2, X3, [SP, -16]! 
	STR	W6, [SP, -16]! 
	MUL	W2, W0, W1 
	MOV	X1, X3 
	LDRB	W0, [X4] 
	BL 	ocorr
	MOV 	W5, W0 
	LDR	W6, [SP], 16 
	LDP	X2, X3, [SP], 16 
	LDP	X0, X1, [SP], 16 
	B 	LOOP

B:	MOV 	W15, 0 
	MOV 	W10, 255 
	MOV 	W11, 0 
	MOV	W12, 0 
	ADD	X2, X2, 1

OUTER:	CMP	W11, W1 
	B.EQ	LOOP
	ADD	W11, W11, 1
	MOV	W12, 0 

INNER:	CMP	W12, W0 
	B.EQ	OUTER
	SUB	W9, W11, 1
	MADD	W13, W9, W0, W12 
	ADD	W12, W12, 1
	LDRB	W14, [X3, X13] 
	CMP 	W14, 127
	B.LE	ZERO
	STRB	W10, [X3, X13] 
	B	INNER

ZERO:	STRB	W15, [X3, X13] 
	B 	INNER

P:	ADD	X2, X2, 1
	LDRB	W11, [X2] 
	ADD 	X2, X2, 1
	LDRB 	W12, [X2] 
	ADD 	X2, X2, 1
	LDRB 	W13, [X2] 
	MADD	W14, W12, W0, W11 
	STRB	W13, [X3, X14] 
	ADD	X2, X2, 1
	B	LOOP

C:	MOV 	W14, 0 
	ADD	X2, X2, 1
	LDRB	W11, [X2] 
	ADD	X2, X2, 1
	LDRB	W12, [X2] 
	ADD 	X2, X2, 1

AUXC:	CMP	W1, W14
	B.EQ 	LOOP
	MADD	W13, W14, W0, W11 
	STRB	W12, [X3, X13] 
	ADD	W14, W14, 1
	B	AUXC

L:	MOV 	W14, 0 
	ADD	X2, X2, 1
	LDRB	W11, [X2] 
	ADD 	X2, X2, 1
	LDRB	W12, [X2] 
	ADD	X2, X2, 1

AUXL:	CMP	W0, W14
	B.EQ	LOOP
	MADD	W13, W11, W0, W14 
	STRB 	W12, [X3, X13] 
	ADD 	W14, W14, 1
	B 	AUXL

END:	CMP 	W6, 0 
	B.NE	AUXEND
	MOV	W0, -1
	LDP	X29, X30, [SP], 16 
	RET

AUXEND:	MOV	W0, W5 
	LDP	X29, X30, [SP], 16 
	RET
